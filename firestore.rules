rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Regras para usuários GLESP
    match /usuarios_glesp/{userId} {
      // Apenas o próprio usuário pode ler seus dados
      allow read: if request.auth != null && request.auth.uid == userId;
      // Apenas administradores podem criar/atualizar usuários
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/usuarios_glesp/$(request.auth.uid)).data.perfil == 'administrador';
    }
    
    // Regras para protocolos GLESP
    match /protocolos_glesp/{protocolId} {
      // Usuários autenticados podem ler protocolos
      allow read: if request.auth != null;
      // Usuários autenticados podem criar protocolos
      allow create: if request.auth != null;
      // Apenas o criador ou administradores podem atualizar
      allow update: if request.auth != null && 
        (resource.data.criado_por == request.auth.uid || 
         get(/databases/$(database)/documents/usuarios_glesp/$(request.auth.uid)).data.perfil == 'administrador');
      // Apenas administradores podem deletar
      allow delete: if request.auth != null && 
        get(/databases/$(database)/documents/usuarios_glesp/$(request.auth.uid)).data.perfil == 'administrador';
    }
    
    // Regras para logs (apenas administradores)
    match /logs/{logId} {
      allow read, write: if request.auth != null && 
        get(/databases/$(database)/documents/usuarios_glesp/$(request.auth.uid)).data.perfil == 'administrador';
    }
  }
}
